const twilio = require('twilio');

// u0625u0639u062fu0627u062f Twilio
const twilioAccountSid = process.env.TWILIO_ACCOUNT_SID || 'YOUR_TWILIO_ACCOUNT_SID';
const twilioAuthToken = process.env.TWILIO_AUTH_TOKEN || 'YOUR_TWILIO_AUTH_TOKEN';
const twilioPhoneNumber = process.env.TWILIO_PHONE_NUMBER || 'YOUR_TWILIO_PHONE_NUMBER';

// u0625u0646u0634u0627u0621 u0639u0645u064au0644 Twilio
const client = twilio(twilioAccountSid, twilioAuthToken);

/**
 * u0625u0631u0633u0627u0644 u0631u0633u0627u0644u0629 u0646u0635u064au0629 u0642u0635u064au0631u0629 u062au062du062au0648u064a u0639u0644u0649 u0631u0645u0632 u0627u0644u062au062du0642u0642
 * @param {string} phoneNumber - u0631u0642u0645 u0627u0644u0647u0627u062au0641 u0627u0644u0645u0633u062au0644u0645 (u064au062cu0628 u0623u0646 u064au0643u0648u0646 u0628u0627u0644u0635u064au063au0629 u0627u0644u062fu0648u0644u064au0629 +966XXXXXXXXX)
 * @param {string} verificationCode - u0631u0645u0632 u0627u0644u062au062du0642u0642 u0627u0644u0645u0631u0627u062f u0625u0631u0633u0627u0644u0647
 * @returns {Promise} - u0648u0639u062f u064au062du062au0648u064a u0639u0644u0649 u0646u062au064au062cu0629 u0627u0644u0625u0631u0633u0627u0644
 */
exports.sendVerificationSMS = async (phoneNumber, verificationCode) => {
  try {
    // u0627u0644u062au0623u0643u062f u0645u0646 u0623u0646 u0631u0642u0645 u0627u0644u0647u0627u062au0641 u064au0628u062fu0623 u0628u0639u0644u0627u0645u0629 +
    if (!phoneNumber.startsWith('+')) {
      phoneNumber = `+${phoneNumber}`;
    }

    // u0625u0631u0633u0627u0644 u0627u0644u0631u0633u0627u0644u0629
    const message = await client.messages.create({
      body: `u0631u0645u0632 u0627u0644u062au062du0642u0642 u0627u0644u062eu0627u0635 u0628u062au0637u0628u064au0642 u0631u0643u0646 u0647u0648: ${verificationCode}. u064au0631u062cu0649 u0639u062fu0645 u0645u0634u0627u0631u0643u0629 u0647u0630u0627 u0627u0644u0631u0645u0632 u0645u0639 u0623u064a u0634u062eu0635.`,
      from: twilioPhoneNumber,
      to: phoneNumber,
    });

    return { success: true, message };
  } catch (error) {
    console.error('Error sending SMS:', error);
    if (process.env.NODE_ENV !== 'production') {
      // u0641u064a u0628u064au0626u0629 u0627u0644u062au0637u0648u064au0631u060c u0646u0637u0628u0639 u0631u0645u0632 u0627u0644u062au062du0642u0642 u0628u062fu0644u0627u064b u0645u0646 u0625u0631u0633u0627u0644u0647 u0641u0639u0644u064au0627u064b
      console.log(`[DEV MODE] u0631u0645u0632 u0627u0644u062au062du0642u0642 u0644u0644u0631u0642u0645 ${phoneNumber} u0647u0648: ${verificationCode}`);
      return { success: true, dev: true, code: verificationCode };
    }
    throw error;
  }
};

/**
 * u0627u0644u062au062du0642u0642 u0645u0646 u0635u062du0629 u0631u0642u0645 u0627u0644u0647u0627u062au0641
 * @param {string} phoneNumber - u0631u0642u0645 u0627u0644u0647u0627u062au0641 u0627u0644u0645u0631u0627u062f u0627u0644u062au062du0642u0642 u0645u0646u0647
 * @returns {boolean} - u0635u062du064au062d u0625u0630u0627 u0643u0627u0646 u0631u0642u0645 u0627u0644u0647u0627u062au0641 u0635u062du064au062du0627u064b
 */
exports.validatePhoneNumber = (phoneNumber) => {
  // u0646u0645u0637 u0628u0633u064au0637 u0644u0631u0642u0645 u0627u0644u0647u0627u062au0641 u0627u0644u0633u0639u0648u062fu064a - u064au0645u0643u0646 u062au0639u062fu064au0644u0647 u062du0633u0628 u0627u0644u062du0627u062cu0629
  const saudiPhoneRegex = /^(\+9665|05)\d{8}$/;
  return saudiPhoneRegex.test(phoneNumber);
};

/**
 * u062au0646u0633u064au0642 u0631u0642u0645 u0627u0644u0647u0627u062au0641 u0625u0644u0649 u0627u0644u0635u064au063au0629 u0627u0644u062fu0648u0644u064au0629
 * @param {string} phoneNumber - u0631u0642u0645 u0627u0644u0647u0627u062au0641 u0627u0644u0645u0631u0627u062f u062au0646u0633u064au0642u0647
 * @returns {string} - u0631u0642u0645 u0627u0644u0647u0627u062au0641 u0628u0627u0644u0635u064au063au0629 u0627u0644u062fu0648u0644u064au0629
 */
exports.formatPhoneNumber = (phoneNumber) => {
  // u0625u0632u0627u0644u0629 u0627u0644u0645u0633u0627u0641u0627u062a u0627u0644u0628u064au0636u0627u0621 u0648u0627u0644u0634u0631u0637u0627u062a
  phoneNumber = phoneNumber.replace(/\s+|-/g, '');
  
  // u0625u0630u0627 u0643u0627u0646 u0627u0644u0631u0642u0645 u064au0628u062fu0623 u0628u0640 05u060c u0646u0642u0648u0645 u0628u062au062du0648u064au0644u0647 u0625u0644u0649 u0627u0644u0635u064au063au0629 u0627u0644u062fu0648u0644u064au0629
  if (phoneNumber.startsWith('05')) {
    return '+966' + phoneNumber.substring(1);
  }
  
  // u0625u0630u0627 u0643u0627u0646 u0627u0644u0631u0642u0645 u064au0628u062fu0623 u0628u0640 966 u0628u062fu0648u0646 +u060c u0646u0636u064au0641 +
  if (phoneNumber.startsWith('966')) {
    return '+' + phoneNumber;
  }
  
  // u0625u0630u0627 u0643u0627u0646 u0627u0644u0631u0642u0645 u064au0628u062fu0623 u0628u0640 +966u060c u0646u0639u064au062fu0647 u0643u0645u0627 u0647u0648
  if (phoneNumber.startsWith('+966')) {
    return phoneNumber;
  }
  
  // u0641u064a u062du0627u0644u0629 u0643u0627u0646 u0627u0644u0631u0642u0645 u0644u0627 u064au062au0628u0639 u0627u0644u0635u064au063au0629 u0627u0644u0645u062au0648u0642u0639u0629u060c u0646u0639u064au062fu0647 u0643u0645u0627 u0647u0648
  return phoneNumber;
};
